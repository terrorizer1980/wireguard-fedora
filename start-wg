#!/bin/bash

if [ ! -e /etc/wireguard/wg0.conf ]; then
    echo "$(date): /etc/wireguard/wg0.conf not found" >&2
    exit 1
fi

wg_up() {
    echo "$(date): wg_up"
    wg-quick up wg0
    if [ $? -eq 0 ]; then 
        wg && iptables -w -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    fi
}

wg_down() {
    echo "$(date): wg_down"
    wg-quick down wg0
    iptables -w -t nat -D POSTROUTING -o eth0 -j MASQUERADE
}

wg_up

finish() {
    echo "$(date): finish"
    wg_down
    exit 0
}

trap finish TERM INT QUIT

# '$!' is the process ID of the job most recently placed into the background
sleep infinity & wait $!
